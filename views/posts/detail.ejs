<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/posts">Browse</a></li>
      <li class="breadcrumb-item"><a href="/posts?type=<%= post.type %>"><%= post.type %></a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= post.title %></li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm rounded-3 overflow-hidden mb-4">
        <div class="position-relative">
          <% if (post.images && post.images.length) { %>
          <div id="postCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <% post.images.forEach(function(img, i) { %>
              <div class="carousel-item <%= i === 0 ? 'active' : '' %>">
                <img src="<%= img %>" class="d-block w-100" style="max-height: 400px; object-fit: contain; background: #f8f9fa;" alt="">
              </div>
              <% }); %>
            </div>
            <% if (post.images.length > 1) { %>
            <button class="carousel-control-prev" type="button" data-bs-target="#postCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#postCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
            <% } %>
          </div>
          <% } else { %>
          <div class="bg-light d-flex align-items-center justify-content-center" style="height: 280px;"><i class="bi bi-image display-1 text-muted"></i></div>
          <% } %>
          <span class="position-absolute top-0 start-0 badge bg-<%= post.type === 'lost' ? 'warning' : 'success' %> text-dark m-3"><%= post.type %></span>
          <span class="position-absolute top-0 end-0 badge bg-secondary m-3"><%= post.status %></span>
        </div>
        <div class="card-body p-4">
          <h1 class="h3 fw-bold mb-2"><%= post.title %></h1>
          <p class="text-muted small mb-3"><%= post.category %><% if (post.location) { %> · <%= post.location %><% } %><% if (post.dateOccurrence) { %> · <%= new Date(post.dateOccurrence).toLocaleDateString() %><% } %></p>
          <div class="post-description"><%= post.description %></div>
          <% if (user && user._id && post.author && String(post.author._id) === String(user._id)) { %>
          <hr>
          <div class="d-flex flex-wrap gap-2">
            <a href="/posts/<%= post._id %>/edit" class="btn btn-outline-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit</a>
            <form action="/posts/<%= post._id %>/status" method="post" class="d-inline">
              <input type="hidden" name="status" value="resolved">
              <button type="submit" class="btn btn-outline-success btn-sm">Mark resolved</button>
            </form>
            <form action="/posts/<%= post._id %>/status" method="post" class="d-inline">
              <input type="hidden" name="status" value="closed">
              <button type="submit" class="btn btn-outline-secondary btn-sm">Close</button>
            </form>
          </div>
          <% } %>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-3 overflow-hidden mb-4">
        <div class="card-header bg-light"><strong>Posted by</strong></div>
        <div class="card-body d-flex align-items-center gap-3">
          <% if (post.author && post.author.photo) { %>
          <img src="<%= post.author.photo %>" alt="" class="rounded-circle" width="56" height="56" style="object-fit: cover;">
          <% } else { %>
          <div class="rounded-circle bg-primary bg-opacity-25 d-flex align-items-center justify-content-center" width="56" height="56" style="width:56px;height:56px;"><i class="bi bi-person text-primary fs-4"></i></div>
          <% } %>
          <div>
            <div class="fw-semibold"><% if (post.author && post.author._id) { %><a href="/profile/<%= post.author._id %>" class="text-decoration-none"><%= post.author.fullName %></a><% } else { %><%= post.author ? post.author.fullName : 'Unknown' %><% } %></div>
            <% if (post.author && post.author.degreeLevel) { %><div class="small text-muted"><%= typeof degreeLabels !== 'undefined' && degreeLabels[post.author.degreeLevel] ? degreeLabels[post.author.degreeLevel] : post.author.degreeLevel %></div><% } %>
            <% if (post.author && post.author.course) { %><div class="small text-muted"><%= post.author.course %><% if (post.author.yearOfStudy) { %> · <%= post.author.yearOfStudy %><% } %></div><% } %>
            <% if (post.author && post.author.regNumber) { %><div class="small text-muted">Reg: <%= post.author.regNumber %></div><% } %>
          </div>
        </div>
        <div class="card-footer bg-light small text-muted">
          <% if (post.author && post.author._id) { %><a href="/profile/<%= post.author._id %>">View profile</a> · <% } %>Contact via the poster's preferred method. Do not share sensitive data in public.
        </div>
      </div>

      <section id="comments" class="card border-0 shadow-sm rounded-3 overflow-hidden mb-4">
        <div class="card-header bg-light"><strong>Comments</strong> <% if (typeof comments !== 'undefined' && comments.length) { %><span class="badge bg-secondary"><%= comments.length %></span><% } %></div>
        <div class="card-body">
          <% if (user) { %>
          <form action="/posts/<%= post._id %>/comments" method="post" class="mb-4">
            <textarea name="body" class="form-control mb-2" rows="2" placeholder="Add a comment..." maxlength="1000" required></textarea>
            <button type="submit" class="btn btn-primary btn-sm">Post comment</button>
          </form>
          <% } else { %>
          <p class="small text-body-secondary mb-3"><a href="/auth/login">Log in</a> to comment.</p>
          <% } %>
          <% if (typeof comments !== 'undefined' && comments.length) { %>
          <div class="list-group list-group-flush">
            <% comments.forEach(function(c) { %>
            <div class="list-group-item px-0 d-flex gap-2 align-items-start">
              <% if (c.author && c.author.photo) { %>
              <img src="<%= c.author.photo %>" alt="" class="rounded-circle flex-shrink-0" width="36" height="36" style="object-fit: cover;">
              <% } else { %>
              <div class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0" style="width:36px;height:36px;"><i class="bi bi-person text-muted small"></i></div>
              <% } %>
              <div class="flex-grow-1 min-width-0">
                <div class="small fw-semibold"><%= c.author ? c.author.fullName : 'Unknown' %></div>
                <p class="mb-0 small"><%= c.body %></p>
                <div class="small text-body-secondary mt-1"><%= new Date(c.createdAt).toLocaleString() %><% if (user && c.author && String(c.author._id) === String(user._id)) { %> · <form action="/comments/<%= c._id %>/delete" method="post" class="d-inline"><button type="submit" class="btn btn-link btn-sm p-0 text-danger">Delete</button></form><% } %></div>
              </div>
            </div>
            <% }); %>
          </div>
          <% } else { %>
          <p class="small text-body-secondary mb-0">No comments yet.</p>
          <% } %>
        </div>
      </section>

      <% if (similar && similar.length) { %>
      <h2 class="h6 fw-bold mb-2">Similar <%= post.type %> items</h2>
      <div class="list-group list-group-flush rounded-3 border shadow-sm">
        <% similar.forEach(function(s) { %>
        <a href="/posts/<%= s._id %>" class="list-group-item list-group-item-action d-flex gap-2 align-items-center">
          <% if (s.images && s.images[0]) { %>
          <img src="<%= s.images[0] %>" alt="" width="48" height="48" class="rounded object-fit-cover">
          <% } else { %>
          <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width:48px;height:48px;"><i class="bi bi-image text-muted"></i></div>
          <% } %>
          <span class="text-truncate"><%= s.title %></span>
        </a>
        <% }); %>
      </div>
      <% } %>
    </div>
  </div>
</div>
